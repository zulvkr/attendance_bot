# Attendance Bot

A Telegram bot for employee attendance tracking using TOTP (Time-based One-Time Password) authentication with SQLite database storage.

## Features

- ğŸ” TOTP-based attendance marking
- â° Automatic late detection (after 9:00 AM)
- ğŸ“Š Daily attendance reports
- ğŸ“ˆ Personal attendance history
- ğŸš« Prevents duplicate attendance marking per day
- ğŸ’¾ SQLite database for persistent data storage
- ğŸ” Knex.js query builder for type-safe database operations

## Tech Stack

- **TypeScript** - Type-safe JavaScript
- **Telegraf** - Telegram Bot API framework
- **SQLite3** - Lightweight embedded database
- **Knex.js** - SQL query builder
- **OTPLIB** - TOTP authentication
- **date-fns** - Date utility functions

## Setup

### 1. Install Dependencies

```bash
pnpm install
```

### 2. Create Telegram Bot

1. Message [@BotFather](https://t.me/botfather) on Telegram
2. Create a new bot with `/newbot`
3. Copy the bot token

### 3. Generate TOTP Secret

Run the setup script to generate a TOTP secret and QR code:

```bash
pnpm run setup-totp
```

This will:

- Generate a new TOTP secret
- Display a QR code for your authenticator app
- Show setup instructions

### 4. Configure Environment

1. Copy `.env.example` to `.env`
2. Add your bot token and TOTP secret:

```env
BOT_TOKEN=your_telegram_bot_token_here
TOTP_SECRET=your_generated_totp_secret_here
```

### 5. Initialize Database

The database will be automatically created when you first run the bot. Optionally, you can run the migration script:

```bash
pnpm run migrate
```

## Database Structure

The bot uses SQLite with the following table structure:

### `attendance` table

| Column    | Type    | Description                  |
| --------- | ------- | ---------------------------- |
| id        | INTEGER | Primary key (auto-increment) |
| userId    | INTEGER | Telegram user ID             |
| username  | TEXT    | Telegram username            |
| firstName | TEXT    | User's first name            |
| lastName  | TEXT    | User's last name (nullable)  |
| timestamp | TEXT    | ISO timestamp of attendance  |
| status    | TEXT    | 'present' or 'late'          |
| date      | TEXT    | Date in YYYY-MM-DD format    |

**Indexes:**

- `idx_user_date` on (userId, date) for fast user attendance lookups
- `idx_date` on date for daily reports
- Unique constraint on (userId, date) to prevent duplicate attendance

### 6. Setup Authenticator App

1. Install an authenticator app (Google Authenticator, Authy, etc.)
2. Scan the QR code generated by the setup script
3. Or manually enter the TOTP secret

### 6. Run the Bot

Development mode:

```bash
pnpm run dev
```

Production mode:

```bash
pnpm run build
pnpm start
```

## Usage

### For Employees

1. Open the bot in Telegram
2. Send `/start` to see instructions
3. Get your 6-digit code from your authenticator app
4. Send the code to mark attendance

### Available Commands

- ğŸ“ **Send OTP** - Mark attendance with 6-digit code
- ğŸ“Š `/report` - View today's attendance report
- ğŸ“ˆ `/history` - View your attendance history (30 days)
- ğŸ”„ `/status` - Check if you've marked attendance today
- â“ `/help` - Show help message

### Attendance Rules

- âœ… **On Time**: Attendance marked before 9:00 AM
- âš ï¸ **Late**: Attendance marked after 9:00 AM
- ğŸš« **Once per day**: Each employee can only mark attendance once per day

## Security Features

- TOTP authentication prevents unauthorized attendance
- Time-based codes expire every 30 seconds
- No storage of sensitive authentication data
- User identification through Telegram IDs

## Technical Details

- Built with Node.js and TypeScript
- Uses Telegraf for Telegram bot framework
- TOTP implementation with otplib
- In-memory attendance storage (resets daily)
- QR code generation for easy setup

## Development

The bot consists of:

- `app.ts` - Main bot logic and command handlers
- `attendance.ts` - Attendance service and TOTP verification
- `environment.ts` - Environment configuration with validation
- `setup-totp.ts` - Utility for generating TOTP secrets

## Future Enhancements

- Database persistence for attendance records
- Admin commands for managing users
- Export attendance reports
- Integration with HR systems
- Multiple attendance windows per day
